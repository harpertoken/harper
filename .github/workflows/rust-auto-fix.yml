name: Rust Auto-Fix Bot
on:
  issue_comment:
    types: [created]

jobs:
  rust-auto-fix-request:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/rust-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
    - name: Check what fixes are requested
      id: check
      env:
        COMMENT_BODY: ${{ github.event.comment.body }}
      run: |
        comment="$COMMENT_BODY"
        fixes=""
        if [[ "$comment" == *"/rust-fix fmt"* ]]; then
          fixes="cargo fmt"
        fi
        if [[ "$comment" == *"/rust-fix clippy"* ]]; then
          fixes="${fixes:+$fixes + }clippy --fix"
        fi
        if [[ "$comment" == *"/rust-fix all"* ]]; then
          fixes="cargo fmt + clippy --fix"
        fi
        echo "fixes=$fixes" >> "$GITHUB_OUTPUT"

    - name: Comment confirmation
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸ¦€ **Rust Auto-Fix Bot**

          I'll apply: \`${{ steps.check.outputs.fixes }}\`

          Reply with \`/confirm\` to proceed or \`/cancel\` to abort.`
          })

  rust-auto-fix-execute:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/confirm')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Get PR info
      id: pr
      run: |
        pr_number=${{ github.event.issue.number }}
        gh pr checkout "$pr_number"
        echo "branch=$(git branch --show-current)" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config libsqlite3-dev

    - name: Get previous bot comment
      id: prev
      uses: actions/github-script@v7
      with:
        script: |
          const comments = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          const botComment = comments.data.reverse().find(c =>
            c.user.login === 'github-actions[bot]' &&
            c.body.includes('Rust Auto-Fix Bot')
          );
          if (botComment) {
            const fixes = botComment.body.match(/I'll apply: `([^`]+)`/)?.[1] || '';
            core.setOutput('fixes', fixes);
          }

    - name: Apply Rust fixes
      run: |
        fixes="${{ steps.prev.outputs.fixes }}"
        if [[ "$fixes" == *"cargo fmt"* ]]; then
          cargo fmt
          echo "âœ… Applied cargo fmt"
        fi
        if [[ "$fixes" == *"clippy"* ]]; then
          cargo clippy --fix --allow-dirty --allow-staged
          echo "âœ… Applied clippy auto-fixes"
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Rust Auto-Fix Bot"
        if git diff --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        git add .
        git commit -m "ðŸ¦€ Auto-fix: ${{ steps.prev.outputs.fixes }}"
        git push
